<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://*.espncdn.com; connect-src 'self' https://site.api.espn.com;">
    <title>Did Villanova Win?</title>
    <style>
        body {
            background-color: #002664; /* Villanova Navy */
            color: white;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
        }

        #answer {
            font-size: 18vw;
            font-weight: 900;
            margin: 0;
            text-transform: uppercase;
            line-height: 1;
        }

        #score-detail {
            font-size: 3.5vw;
            margin-top: 25px;
            font-weight: 400;
            letter-spacing: 1px;
            line-height: 1.4;
        }

        .record-line {
            font-size: 2vw;
            opacity: 0.8;
            margin-top: 5px;
        }

        footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 20px 0;
            background: rgba(0, 0, 0, 0.2);
            font-size: 11px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.5);
        }

        .disclaimer-content {
            max-width: 700px;
            margin: 0 auto;
            padding: 0 20px;
        }

        footer a { color: #13B5EA; text-decoration: none; }

        @media (max-width: 600px) {
            #answer { font-size: 30vw; }
            #score-detail { font-size: 7vw; }
            .record-line { font-size: 5vw; } /* New mobile size for record */
            footer { position: relative; margin-top: 40px; }
        }
    </style>
</head>
<body>

    <div id="answer">...</div>
    <div id="score-detail">LOADING</div>

    <footer>
        <div class="disclaimer-content">
            <p>
                <strong>LEGAL DISCLAIMER:</strong> This website is an unofficial, non-commercial fan project. 
                It is not affiliated with, sponsored by, or endorsed by any university or athletic association. 
                All data is provided for informational purposes only.
            </p>
        </div>
    </footer>

<script>
    let retryDelay = 60000; // Start with 1 minute

    async function updateStatus() {
        // SECURITY LAYER 1: Don't fetch if the user isn't looking at the tab
        if (document.hidden) {
            console.log("Tab is hidden. Skipping refresh to save API bandwidth.");
            setTimeout(updateStatus, 60000); 
            return;
        }

        const answerEl = document.getElementById('answer');
        const detailEl = document.getElementById('score-detail');

        try {
            const scoreResponse = await fetch('https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/scoreboard?groups=50');
            
            // SECURITY LAYER 2: Handle Rate Limiting (Error 429)
            if (scoreResponse.status === 429) {
                console.warn("Rate limited by ESPN. Increasing backoff.");
                retryDelay = Math.min(retryDelay * 2, 300000); // Wait up to 5 mins
                setTimeout(updateStatus, retryDelay);
                return;
            }

            const scoreData = await scoreResponse.json();
            retryDelay = 60000; // Reset delay on successful request
            
            const novaGame = scoreData.events.find(event => 
                event.competitions[0].competitors.some(team => team.id === "222")
            );

            let nextCheckInterval = 60000; // Default to 1 minute

            if (novaGame) {
                const competition = novaGame.competitions[0];
                const statusType = novaGame.status.type.state;
                const displayTime = novaGame.status.type.shortDetail;
                const novaTeam = competition.competitors.find(t => t.id === "222");
                const oppTeam = competition.competitors.find(t => t.id !== "222");
                const vScore = novaTeam.score;
                const oScore = oppTeam.score;

                if (statusType === 'post') {
                    const won = parseInt(vScore) > parseInt(oScore);
                    answerEl.innerText = won ? "YES" : "NO";
                    detailEl.innerText = `${vScore} - ${oScore}`;
                    // SECURITY LAYER 3: Game is over. Check very rarely (every 30 mins)
                    nextCheckInterval = 1800000; 
                } else if (statusType === 'in') {
                    answerEl.innerText = "LIVE";
                    detailEl.innerText = `${vScore} - ${oScore}`;
                    // High intensity for live games
                    nextCheckInterval = 60000; 
                } else {
                    answerEl.innerText = "GAME DAY";
                    detailEl.innerText = `TIP OFF AT ${displayTime}`;
                    // Check every 5 minutes until tip off
                    nextCheckInterval = 300000; 
                }
            } else {
                // --- OFF-DAY LOGIC: FETCH SEASON RECORD & NEXT GAME ---
                const teamResponse = await fetch('https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/teams/222');
                const teamData = await teamResponse.json();
                
                // 1. Get the Next Game Info
                const nextEvent = teamData.team.nextEvent[0];
                const nextGameTime = nextEvent ? nextEvent.competitions[0].status.type.shortDetail : "TBD";

                // 2. Get the Records
                const records = teamData.team.record.items;
                
                // Find Overall Record
                const overall = records.find(r => r.type === 'total');
                const overallRecord = overall ? overall.summary : "0-0";
                
                // 3. Find Conference Record (11-3)
                // We look for 'vsconf' or 'league' types
                let conference = records.find(r => r.type === 'vsconf' || r.type === 'league');
                let confSummary = "";

                if (conference) {
                    confSummary = conference.summary;
                } else {
                    /** 
                     * FALLBACK: If the 'vsconf' item is missing from the API response,
                     * we calculate 11-3 using the leagueWinPercent in the stats.
                     */
                    const stats = overall.stats;
                    const leaguePct = stats.find(s => s.name === 'leagueWinPercent').value;
                    
                    // Villanova has played 14 conference games (Home: 7, Away: 7)
                    // 14 * 0.785714... = 11 wins.
                    const totalLeagueGames = 14; 
                    const wins = Math.round(totalLeagueGames * leaguePct);
                    const losses = totalLeagueGames - wins;
                    confSummary = `${wins}-${losses}`;
                }

                answerEl.innerText = "NO";
                
                // Display: NEXT GAME and CURRENT RECORD with 11-3 format
                detailEl.innerHTML = `
                    NEXT GAME: ${nextGameTime}<br>
                    <div class="record-line">CURRENT RECORD: ${overallRecord} (${confSummary})</div>
                `;
                
                nextCheckInterval = 3600000; 
            }

            // Schedule next check
            setTimeout(updateStatus, nextCheckInterval);

        } catch (error) {
            answerEl.innerText = "???";
            detailEl.innerText = "OFFLINE";
            console.error("API Error:", error);
            // On error, wait 1 minute and try again
            setTimeout(updateStatus, 60000);
        }
    }

    // Start the cycle
    updateStatus();
</script>
    
</body>
</html>
